<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filter Matters</title>

  <!-- Grist Plugin API (required for hosted widgets) -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script> <!-- [1](https://py-grist-api.readthedocs.io/en/latest/grist_api.html)[2](https://stackoverflow.com/questions/17012727/how-to-set-the-x-frame-options-in-a-content-hosted-by-github) -->

  <style>
    :root{
      /* Light gray app theme */
      --page:   #f3f4f6;
      --card:   #ffffff;
      --ink:    #0f172a;
      --muted:  #64748b;
      --border: rgba(15,23,42,.12);
      --shadow: 0 8px 18px rgba(15,23,42,.08);
      --ring:   rgba(100,116,139,.30);

      /* Slim sizing (aim for ~1.5in widget height when you resize the section) */
      --pad: 5px;
      --gap: 5px;
      --radius: 12px;
      --controlH: 24px;         /* slimmer controls */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: var(--font);
      background: var(--page);
      color: var(--ink);
    }

    .shell{ padding: var(--pad); }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--gap);
      padding: 5px 7px;                 /* slimmer */
      background: #fafafa;
      border-bottom: 1px solid var(--border);
    }

    .title{
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
    }

    .right{
      display:flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
    }

    .pill{
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f1f5f9;
      border: 1px solid rgba(15,23,42,.10);
      color: #111827;
    }

    button{
      height: var(--controlH);
      padding: 0 8px;
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,.14);
      background: #f8fafc;
      color: #111827;
      font-size: 11px;
      cursor:pointer;
    }
    button:hover{ background:#f1f5f9; }
    button:focus{ outline:none; box-shadow: 0 0 0 3px var(--ring); }

    .content{
      padding: 6px 7px 7px;             /* slimmer */
      display:grid;
      gap: var(--gap);
    }

    .row{
      display:grid;
      gap: var(--gap);
      align-items:end;
    }

    /* Row 1: 4 filters */
    .rowFilters{
      grid-template-columns: 0.8fr 0.8fr 1fr 1fr;
    }

    /* OR divider row */
    .orRow{
      display:flex;
      align-items:center;
      gap: 8px;
      margin: -1px 0;                   /* keeps it slim */
    }
    .orLine{
      height: 1px;
      background: rgba(15,23,42,.10);
      flex: 1;
    }
    .orTag{
      font-size: 10px;
      color: var(--muted);
      letter-spacing: .16em;
      font-weight: 800;
    }

    /* Row 2: search */
    .rowSearch{
      grid-template-columns: 1fr;
    }

    .field{
      display:grid;
      gap: 3px;
      min-width: 0;
    }

    label{
      font-size: 10.5px;
      color: var(--muted);
      line-height: 1;
    }

    input, select{
      height: var(--controlH);
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,.14);
      background: #ffffff;
      padding: 0 8px;
      font-size: 11px;
      color: var(--ink);
      outline:none;
      min-width: 0;
    }

    input:focus, select:focus{
      box-shadow: 0 0 0 3px var(--ring);
      border-color: rgba(100,116,139,.45);
    }

    /* Disabled filter look when search is active */
    select:disabled{
      background: #f3f4f6;
      color: #94a3b8;
    }

    .err{
      font-size: 11px;
      color: #b91c1c;
      margin-top: -2px;
      min-height: 14px; /* stabilizes layout */
    }

    @media (max-width: 760px){
      .rowFilters{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="card">
      <div class="topbar">
        <div class="title">Filter Matters</div>
        <div class="right">
          <span class="pill" id="count">0 matches</span>
          <button id="clearBtn" title="Reset filters">Clear</button>
        </div>
      </div>

      <div class="content">
        <!-- Filters row -->
        <div class="row rowFilters">
          <div class="field">
            <label for="yearSel">Select Matter Year</label>
            <select id="yearSel"></select>
          </div>

          <div class="field">
            <label for="statusSel">Select Matter Status</label>
            <select id="statusSel"></select>
          </div>

          <div class="field">
            <label for="lawyerSel">Lawyer</label>
            <select id="lawyerSel"></select>
          </div>

          <div class="field">
            <label for="typeSel">Matter Type</label>
            <select id="typeSel"></select>
          </div>
        </div>

        <!-- OR cue -->
        <div class="orRow" aria-hidden="true">
          <span class="orLine"></span>
          <span class="orTag">OR</span>
          <span class="orLine"></span>
        </div>

        <!-- Search row -->
        <div class="row rowSearch">
          <div class="field">
            <label for="q">Search (MatterID, Clients, Subject, Subject2)</label>
            <input id="q" type="search" placeholder="Type to searchâ€¦" autocomplete="off" />
          </div>
        </div>

        <div class="err" id="err"></div>
      </div>
    </div>
  </div>

  <script>
    // Initialize widget: request read access; enable linking as Select By source. [1](https://py-grist-api.readthedocs.io/en/latest/grist_api.html)[2](https://stackoverflow.com/questions/17012727/how-to-set-the-x-frame-options-in-a-content-hosted-by-github)
    grist.ready({ requiredAccess: "read table", allowSelectBy: true });

    const q = document.getElementById("q");
    const yearSel = document.getElementById("yearSel");
    const statusSel = document.getElementById("statusSel");
    const lawyerSel = document.getElementById("lawyerSel");
    const typeSel = document.getElementById("typeSel");
    const countEl = document.getElementById("count");
    const errEl = document.getElementById("err");
    const clearBtn = document.getElementById("clearBtn");

    let rows = []; // {id, MTR_YEAR, Status, Lawyer, Mtr_Type, _search}
    let state = { query:"", year:"", status:"", lawyer:"", type:"" };

    function norm(v){ return (v === null || v === undefined) ? "" : String(v); }
    function setErr(msg){ errEl.textContent = msg || ""; }

    function uniq(arr){
      const s = new Set(arr.map(norm));
      return [...s].filter(v => v !== "");
    }
    function sortYears(years){
      return years.map(Number).filter(n => !Number.isNaN(n)).sort((a,b)=>b-a).map(String);
    }
    function sortAlpha(items){
      return items.sort((a,b)=>a.localeCompare(b, undefined, { sensitivity:"base" }));
    }

    function fillSelect(sel, items, selected, allLabel){
      sel.innerHTML = "";
      const all = document.createElement("option");
      all.value = "";
      all.textContent = allLabel;
      sel.appendChild(all);

      items.forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        sel.appendChild(o);
      });

      sel.value = selected || "";
    }

    function applyDefaultsIfEmpty(){
      // default year = current year if present
      if (!state.year){
        const currentYear = String(new Date().getFullYear());
        const years = new Set(rows.map(r => norm(r.MTR_YEAR)));
        if (years.has(currentYear)) state.year = currentYear;
      }
      // default status = Active if present
      if (!state.status){
        const statuses = new Set(rows.map(r => norm(r.Status)));
        if (statuses.has("Active")) state.status = "Active";
      }
    }

    function syncUIForMode(){
      const searching = norm(state.query).trim().length > 0;
      yearSel.disabled = searching;
      statusSel.disabled = searching;
      lawyerSel.disabled = searching;
      typeSel.disabled = searching;
    }

    // OR behavior:
    // - If search text exists => ignore ALL dropdown filters, search across ALL rows.
    // - If search empty => apply dropdown filters (AND).
    function computeIds(){
      const qtext = norm(state.query).trim().toLowerCase();

      // Search-only mode
      if (qtext){
        const ids = [];
        for (let i=0; i<rows.length; i++){
          if (rows[i]._search.indexOf(qtext) !== -1) ids.push(rows[i].id);
        }
        return ids;
      }

      // Filter-only mode (AND)
      const y = norm(state.year);
      const s = norm(state.status);
      const l = norm(state.lawyer);
      const t = norm(state.type);

      const ids = [];
      for (let i=0; i<rows.length; i++){
        const r = rows[i];
        if (y && norm(r.MTR_YEAR) !== y) continue;
        if (s && norm(r.Status) !== s) continue;
        if (l && norm(r.Lawyer) !== l) continue;
        if (t && norm(r.Mtr_Type) !== t) continue;
        ids.push(r.id);
      }
      return ids;
    }

    function applySelection(){
      const ids = computeIds();
      countEl.textContent = `${ids.length} matches`;

      // Drive linked widgets by selected rows. [3](https://www.tutorialpedia.org/blog/how-can-i-set-x-frame-options-on-an-iframe/)[2](https://stackoverflow.com/questions/17012727/how-to-set-the-x-frame-options-in-a-content-hosted-by-github)
      grist.setSelectedRows(ids.length ? ids : null);
    }

    function renderOptions(){
      // Option lists always based on ALL rows (not dependent on search or other filters)
      const years = sortYears(uniq(rows.map(r => r.MTR_YEAR)));
      const statuses = sortAlpha(uniq(rows.map(r => r.Status)));
      const lawyers = sortAlpha(uniq(rows.map(r => r.Lawyer)));
      const types = sortAlpha(uniq(rows.map(r => r.Mtr_Type)));

      fillSelect(yearSel, years, state.year, "All years");
      fillSelect(statusSel, statuses, state.status, "All statuses");
      fillSelect(lawyerSel, lawyers, state.lawyer, "All lawyers");
      fillSelect(typeSel, types, state.type, "All types");
    }

    let debounce = null;
    function scheduleApply(ms){
      if (debounce) clearTimeout(debounce);
      debounce = setTimeout(applySelection, ms || 200);
    }

    // Events
    q.addEventListener("input", () => {
      state.query = q.value;
      syncUIForMode();
      scheduleApply(220);
    });

    yearSel.addEventListener("change", () => { state.year = yearSel.value; applySelection(); });
    statusSel.addEventListener("change", () => { state.status = statusSel.value; applySelection(); });
    lawyerSel.addEventListener("change", () => { state.lawyer = lawyerSel.value; applySelection(); });
    typeSel.addEventListener("change", () => { state.type = typeSel.value; applySelection(); });

    clearBtn.addEventListener("click", () => {
      state.query = "";
      state.year = "";
      state.status = "";
      state.lawyer = "";
      state.type = "";
      q.value = "";
      applyDefaultsIfEmpty();   // reapply defaults
      syncUIForMode();
      renderOptions();
      applySelection();
    });

    // Load data once from the selected table. [2](https://stackoverflow.com/questions/17012727/how-to-set-the-x-frame-options-in-a-content-hosted-by-github)[1](https://py-grist-api.readthedocs.io/en/latest/grist_api.html)
    setErr("");
    grist.fetchSelectedTable({ format:"rows" })
      .then(data => {
        const all = data || [];
        if (!all.length){
          setErr("No rows returned. Check Select Data = Matters and access level.");
          return;
        }

        // Validate required columns
        const first = all[0] || {};
        const required = ["MatterID","Clients","Subject","Subject2","Lawyer","Mtr_Type","MTR_YEAR","Status"];
        const missing = required.filter(k => !(k in first));
        if (missing.length){
          setErr("Missing column(s): " + missing.join(", "));
          return;
        }

        // Reduce + precompute search string (fast searching)
        rows = all.map(r => {
          const searchBlob = (
            norm(r.MatterID) + " " +
            norm(r.Clients) + " " +
            norm(r.Subject) + " " +
            norm(r.Subject2)
          ).toLowerCase();

          return {
            id: r.id,
            MTR_YEAR: r.MTR_YEAR,
            Status: r.Status,
            Lawyer: r.Lawyer,
            Mtr_Type: r.Mtr_Type,
            _search: searchBlob
          };
        });

        applyDefaultsIfEmpty();
        renderOptions();
        syncUIForMode();
        applySelection();
      })
      .catch(e => {
        setErr("fetchSelectedTable failed: " + (e && e.message ? e.message : e));
      });
  </script>
</body>
</html>
