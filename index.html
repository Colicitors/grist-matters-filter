<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filter Matters</title>

  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <style>
    :root{
      /* Light gray "app" theme */
      --page: #f3f4f6;          /* bg */
      --card: #ffffff;          /* card */
      --ink:  #0f172a;          /* text */
      --muted:#64748b;          /* labels */
      --border: rgba(15,23,42,.12);
      --shadow: 0 8px 18px rgba(15,23,42,.08);
      --ring: rgba(100,116,139,.35);

      /* Slim sizing */
      --pad: 6px;
      --gap: 6px;
      --radius: 12px;
      --controlH: 26px;         /* slimmer controls */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: var(--font);
      background: var(--page);
      color: var(--ink);
    }

    .shell{ padding: var(--pad); }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--gap);
      padding: 6px 8px;               /* slimmer */
      background: #fafafa;
      border-bottom: 1px solid var(--border);
    }

    .title{
      font-weight: 700;
      font-size: 12.5px;
      letter-spacing: .2px;
    }

    .right{
      display:flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
    }

    .pill{
      font-size: 11.5px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f1f5f9;
      border: 1px solid rgba(15,23,42,.10);
      color: #111827;
    }

    button{
      height: var(--controlH);
      padding: 0 8px;
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,.14);
      background: #f8fafc;
      color: #111827;
      font-size: 11.5px;
      cursor:pointer;
    }
    button:hover{ background:#f1f5f9; }
    button:focus{ outline:none; box-shadow: 0 0 0 3px var(--ring); }

    .content{
      padding: 6px 8px 8px;           /* slimmer */
      display:grid;
      gap: var(--gap);
    }

    .row{
      display:grid;
      gap: var(--gap);
      align-items:end;
    }

    /* Row 1: Year + Status + Lawyer + Type */
    .rowFilters{
      grid-template-columns: 0.8fr 0.8fr 1fr 1fr;
    }

    /* Row 2: Search across full width */
    .rowSearch{
      grid-template-columns: 1fr;
    }

    .field{
      display:grid;
      gap: 3px;                       /* slimmer */
      min-width: 0;
    }

    label{
      font-size: 10.75px;
      color: var(--muted);
      line-height: 1;
    }

    input, select{
      height: var(--controlH);
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,.14);
      background: #ffffff;
      padding: 0 8px;
      font-size: 11.5px;
      color: var(--ink);
      outline:none;
      min-width: 0;
    }

    input:focus, select:focus{
      box-shadow: 0 0 0 3px var(--ring);
      border-color: rgba(100,116,139,.45);
    }

    .err{
      font-size: 11px;
      color: #b91c1c;
      margin-top: -2px;
      min-height: 14px; /* keeps layout stable even when empty */
    }

    /* Responsive fallback */
    @media (max-width: 760px){
      .rowFilters{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="card">
      <div class="topbar">
        <div class="title">Filter Matters</div>
        <div class="right">
          <span class="pill" id="count">0 matches</span>
          <button id="clearBtn" title="Reset filters">Clear</button>
        </div>
      </div>

      <div class="content">
        <div class="row rowFilters">
          <div class="field">
            <label for="yearSel">Select Matter Year</label>
            <select id="yearSel"></select>
          </div>

          <div class="field">
            <label for="statusSel">Select Matter Status</label>
            <select id="statusSel"></select>
          </div>

          <div class="field">
            <label for="lawyerSel">Lawyer</label>
            <select id="lawyerSel"></select>
          </div>

          <div class="field">
            <label for="typeSel">Matter Type</label>
            <select id="typeSel"></select>
          </div>
        </div>

        <div class="row rowSearch">
          <div class="field">
            <label for="q">Search (MatterID, Clients, Subject, Subject2)</label>
            <input id="q" type="search" placeholder="Type to searchâ€¦" autocomplete="off" />
          </div>
        </div>

        <div class="err" id="err"></div>
      </div>
    </div>
  </div>

  <script>
    // Init: allow linking + read access
    grist.ready({ requiredAccess: "read table", allowSelectBy: true });

    const q = document.getElementById("q");
    const yearSel = document.getElementById("yearSel");
    const statusSel = document.getElementById("statusSel");
    const lawyerSel = document.getElementById("lawyerSel");
    const typeSel = document.getElementById("typeSel");
    const countEl = document.getElementById("count");
    const errEl = document.getElementById("err");
    const clearBtn = document.getElementById("clearBtn");

    // Keep only what we need + a precomputed search string
    // Expected keys (based on your earlier debug): MatterID, Clients, Subject, Subject2, Lawyer, Mtr_Type, MTR_YEAR, Status
    let rows = []; // {id, MTR_YEAR, Status, Lawyer, Mtr_Type, _search}
    let state = { query:"", year:"", status:"", lawyer:"", type:"" };

    function norm(v){ return (v === null || v === undefined) ? "" : String(v); }
    function setErr(msg){ errEl.textContent = msg || ""; }

    function uniq(arr){
      const s = new Set(arr.map(norm));
      return [...s].filter(v => v !== "");
    }
    function sortYears(years){
      return years.map(Number).filter(n => !Number.isNaN(n)).sort((a,b)=>b-a).map(String);
    }
    function sortAlpha(items){
      return items.sort((a,b)=>a.localeCompare(b, undefined, { sensitivity:"base" }));
    }

    function fillSelect(sel, items, selected, allLabel){
      sel.innerHTML = "";
      const all = document.createElement("option");
      all.value = "";
      all.textContent = allLabel;
      sel.appendChild(all);

      items.forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        sel.appendChild(o);
      });

      sel.value = selected || "";
    }

    // Defaults: current year + Active, if available
    function applyDefaultsIfEmpty(){
      if (!state.year){
        const currentYear = String(new Date().getFullYear());
        const years = new Set(rows.map(r => norm(r.MTR_YEAR)));
        if (years.has(currentYear)) state.year = currentYear;
      }
      if (!state.status){
        const statuses = new Set(rows.map(r => norm(r.Status)));
        if (statuses.has("Active")) state.status = "Active";
      }
    }

    // IMPORTANT: Search is independent of dropdown selections in the sense that:
    // - search always searches ALL rows using precomputed _search
    // - dropdown option lists NEVER change based on the search text
    // The final result set is still (dropdown filters AND search), which is the most useful behavior for a filter UI.
    function computeIds(){
      const qtext = norm(state.query).trim().toLowerCase();
      const y = norm(state.year);
      const s = norm(state.status);
      const l = norm(state.lawyer);
      const t = norm(state.type);

      const ids = [];
      for (let i=0; i<rows.length; i++){
        const r = rows[i];

        // dropdown filters (AND)
        if (y && norm(r.MTR_YEAR) !== y) continue;
        if (s && norm(r.Status) !== s) continue;
        if (l && norm(r.Lawyer) !== l) continue;
        if (t && norm(r.Mtr_Type) !== t) continue;

        // search filter (AND) across ALL rows/fields
        if (qtext && r._search.indexOf(qtext) === -1) continue;

        ids.push(r.id);
      }
      return ids;
    }

    function applySelection(){
      const ids = computeIds();
      countEl.textContent = `${ids.length} matches`;
      grist.setSelectedRows(ids.length ? ids : null);
    }

    function renderOptions(){
      // option lists based on ALL rows (not dependent on search or other selections)
      const years = sortYears(uniq(rows.map(r => r.MTR_YEAR)));
      const statuses = sortAlpha(uniq(rows.map(r => r.Status)));
      const lawyers = sortAlpha(uniq(rows.map(r => r.Lawyer)));
      const types = sortAlpha(uniq(rows.map(r => r.Mtr_Type)));

      fillSelect(yearSel, years, state.year, "All years");
      fillSelect(statusSel, statuses, state.status, "All statuses");
      fillSelect(lawyerSel, lawyers, state.lawyer, "All lawyers");
      fillSelect(typeSel, types, state.type, "All types");

      applySelection();
    }

    // Debounce typing for smoothness
    let debounce = null;
    function scheduleApply(){
      if (debounce) clearTimeout(debounce);
      debounce = setTimeout(applySelection, 120);
    }

    // Events
    q.addEventListener("input", () => { state.query = q.value; scheduleApply(); });
    yearSel.addEventListener("change", () => { state.year = yearSel.value; applySelection(); });
    statusSel.addEventListener("change", () => { state.status = statusSel.value; applySelection(); });
    lawyerSel.addEventListener("change", () => { state.lawyer = lawyerSel.value; applySelection(); });
    typeSel.addEventListener("change", () => { state.type = typeSel.value; applySelection(); });

    clearBtn.addEventListener("click", () => {
      state.query = "";
      state.year = "";
      state.status = "";
      state.lawyer = "";
      state.type = "";
      q.value = "";
      applyDefaultsIfEmpty();  // reapply defaults after clear
      renderOptions();
    });

    // Load data once
    setErr("");
    grist.fetchSelectedTable({ format:"rows" })
      .then(data => {
        const all = data || [];
        if (!all.length){
          setErr("No rows returned. Check Select Data = Matters and access level.");
          return;
        }

        // Validate required columns
        const first = all[0] || {};
        const required = ["MatterID","Clients","Subject","Subject2","Lawyer","Mtr_Type","MTR_YEAR","Status"];
        const missing = required.filter(k => !(k in first));
        if (missing.length){
          setErr("Missing column(s): " + missing.join(", "));
          return;
        }

        rows = all.map(r => {
          const searchBlob =
            (norm(r.MatterID) + " " +
             norm(r.Clients) + " " +
             norm(r.Subject) + " " +
             norm(r.Subject2)).toLowerCase();

          return {
            id: r.id,
            MTR_YEAR: r.MTR_YEAR,
            Status: r.Status,
            Lawyer: r.Lawyer,
            Mtr_Type: r.Mtr_Type,
            _search: searchBlob
          };
        });

        applyDefaultsIfEmpty();
        renderOptions();
      })
      .catch(e => {
        setErr("fetchSelectedTable failed: " + (e && e.message ? e.message : e));
      });
  </script>
</body>
</html>
