<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filter Matters</title>

  <!-- ✅ Grist Plugin API (required for hosted widgets) -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <style>
    :root{
      --page:   #162238;
      --card:   rgba(255,255,255,.08);
      --card2:  rgba(255,255,255,.06);

      --ink:    #f1f5f9;
      --muted:  rgba(241,245,249,.72);
      --border: rgba(255,255,255,.16);
      --shadow: 0 10px 24px rgba(0,0,0,.28);

      --accent: #22d3ee;
      --ring:   rgba(34,211,238,.25);

      --pad: 6px;
      --gap: 6px;
      --radius: 12px;

      --controlH: 30px;
      --fs: 13px;
      --fsSmall: 12px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--ink);
      background:
        radial-gradient(760px 260px at 15% 0%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(760px 260px at 85% 0%, rgba(34,211,238,.18), transparent 60%),
        linear-gradient(180deg, #101a2d, var(--page));
    }

    .shell{ padding: var(--pad); }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* --- ONE slim banner row containing everything --- */
    .topbar{
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap: var(--gap);
      padding: 6px 8px;
      background: linear-gradient(90deg, rgba(96,165,250,.12), rgba(34,211,238,.10));
      border-bottom: 1px solid rgba(255,255,255,.12);
    }

    .left{
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
      min-width: 0;
    }

    .title{
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .2px;
      color: #ffffff;
    }

    .tag{
      display:none;
      align-items:center;
      gap:6px;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,.26);
      background: rgba(34,211,238,.14);
      color: #eaffff;
      max-width: 240px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .tag .hl{
      background: rgba(34,211,238,.22);
      border: 1px solid rgba(34,211,238,.34);
      padding: 1px 8px;
      border-radius: 999px;
      color: #ffffff;
      font-weight: 800;
      white-space: nowrap;
    }

    /* ✅ OPTION A: Wrap controls (no scrollbar) */
    .controls{
      display:flex;
      align-items:center;
      gap: var(--gap);
      flex-wrap: wrap;     /* ✅ wraps instead of scrolling */
      overflow: hidden;    /* ✅ no scrollbar */
      min-width: 0;
      padding-bottom: 0;
    }

    input, select{
      height: var(--controlH);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.12);
      padding: 0 10px;
      font-size: var(--fs);
      color: #ffffff;
      outline:none;
      min-width: 0;
      transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
    }
    input::placeholder{ color: rgba(241,245,249,.78); }

    input:focus, select:focus{
      box-shadow: 0 0 0 3px var(--ring);
      border-color: rgba(34,211,238,.55);
      background: rgba(255,255,255,.16);
    }

    select:disabled{
      background: rgba(255,255,255,.07);
      color: rgba(241,245,249,.55);
      border-color: rgba(255,255,255,.12);
    }

    /* ✅ Fix dropdown option list contrast */
    select option{
      background-color: #f8fafc;
      color: #0f172a;
      font-size: 13px;
    }
    select option:checked{
      background-color: #e2e8f0;
      color: #020617;
    }
    select option:disabled{
      background-color: #f1f5f9;
      color: #64748b;
    }

    /* Compact widths: helps avoid wrapping too often */
    .w-year{   width: 130px; }
    .w-status{ width: 150px; }
    .w-lawyer{ width: 150px; }
    .w-type{   width: 150px; }

    .orPill{
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .14em;
      color: rgba(255,255,255,.92);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      user-select:none;
      line-height: 1;
    }

    .searchWrap{
      position: relative;
      width: 280px;
      flex: 1 1 260px;  /* ✅ can shrink/grow to reduce wrapping */
      min-width: 220px;
    }
    .searchWrap input{
      width: 100%;
      padding-right: 32px;
    }

    .clearX{
      position: absolute;
      right: 7px;
      top: 50%;
      transform: translateY(-50%);
      height: 20px;
      width: 20px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.95);
      display: none;
      align-items:center;
      justify-content:center;
      line-height: 1;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
    }
    .clearX:hover{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.30);
    }
    .clearX:focus{
      outline: none;
      box-shadow: 0 0 0 3px var(--ring);
      border-color: rgba(34,211,238,.45);
    }

    .right{
      display:flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
    }

    .pill{
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      color: #ffffff;
    }

    button{
      height: var(--controlH);
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: var(--ink);
      font-size: var(--fsSmall);
      font-weight: 650;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease, transform .05s ease;
    }
    button:hover{
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.28);
    }
    button:active{ transform: translateY(1px); }
    button:focus{
      outline:none;
      box-shadow: 0 0 0 3px var(--ring);
      border-color: rgba(34,211,238,.45);
    }

    /* Minimal content: error line only */
    .content{ padding: 4px 8px 6px; }
    .err{
      font-size: 12px;
      color: #fecaca;
      min-height: 14px;
      white-space: pre-wrap;
    }

    @media (max-width: 980px){
      .topbar{ grid-template-columns: 1fr; align-items: start; }
      .right{ justify-content: flex-start; }
      .orPill{ display:none; }
      .searchWrap{ width: 100%; min-width: 0; }
      .w-year,.w-status,.w-lawyer,.w-type{ width: 100%; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="card">
      <div class="topbar">
        <div class="left">
          <div class="title">Filter Matters</div>
          <span class="tag" id="searchTag">Search <span class="hl" id="searchHL"></span></span>
        </div>

        <div class="controls" aria-label="Matter filters and search">
          <select id="yearSel" class="w-year" aria-label="Select Matter Year"></select>
          <select id="statusSel" class="w-status" aria-label="Select Matter Status"></select>
          <select id="lawyerSel" class="w-lawyer" aria-label="Lawyer"></select>
          <select id="typeSel" class="w-type" aria-label="Matter Type"></select>

          <span class="orPill" aria-hidden="true">OR</span>

          <div class="searchWrap">
            <input
              id="q"
              type="search"
              autocomplete="off"
              placeholder="Search by MatterID, Client, or Subject"
              title="Search by MatterID, Client, or Subject. Press Enter to search. Filters are ignored while searching. Press Esc to clear."
            />
            <button class="clearX" id="clearX" type="button" aria-label="Clear search" title="Clear search">×</button>
          </div>
        </div>

        <div class="right">
          <span class="pill" id="count">0 matches</span>
          <button id="clearBtn" type="button" title="Reset filters and search">Clear</button>
        </div>
      </div>

      <div class="content">
        <div class="err" id="err"></div>
      </div>
    </div>
  </div>

  <script>
    const errEl = document.getElementById("err");
    function setErr(msg){ errEl.textContent = msg || ""; }
    function norm(v){ return (v === null || v === undefined) ? "" : String(v); }

    if (!window.grist) {
      setErr("Grist plugin API did not load (window.grist is undefined). Check the <script src> tag.");
    } else {
      grist.ready({ requiredAccess: "read table", allowSelectBy: true });

      const q = document.getElementById("q");
      const clearX = document.getElementById("clearX");

      const yearSel = document.getElementById("yearSel");
      const statusSel = document.getElementById("statusSel");
      const lawyerSel = document.getElementById("lawyerSel");
      const typeSel = document.getElementById("typeSel");

      const countEl = document.getElementById("count");
      const clearBtn = document.getElementById("clearBtn");

      const searchTag = document.getElementById("searchTag");
      const searchHL = document.getElementById("searchHL");

      let rows = [];
      let state = { queryDraft:"", query:"", year:"", status:"", lawyer:"", type:"" };

      function uniq(arr){
        const s = new Set(arr.map(norm));
        return [...s].filter(v => v !== "");
      }
      function sortYears(years){
        return years.map(Number).filter(n => !Number.isNaN(n)).sort((a,b)=>b-a).map(String);
      }
      function sortAlpha(items){
        return items.sort((a,b)=>a.localeCompare(b, undefined, { sensitivity:"base" }));
      }
      function fillSelect(sel, items, selected, allLabel){
        sel.innerHTML = "";
        const all = document.createElement("option");
        all.value = "";
        all.textContent = allLabel;
        sel.appendChild(all);

        items.forEach(v => {
          const o = document.createElement("option");
          o.value = v;
          o.textContent = v;
          sel.appendChild(o);
        });

        sel.value = selected || "";
      }

      function applyDefaultsIfEmpty(){
        if (!state.year){
          const currentYear = String(new Date().getFullYear());
          const years = new Set(rows.map(r => norm(r.MTR_YEAR)));
          if (years.has(currentYear)) state.year = currentYear;
        }
        if (!state.status){
          const statuses = new Set(rows.map(r => norm(r.Status)));
          if (statuses.has("Active")) state.status = "Active";
        }
      }

      function searching(){ return norm(state.query).trim().length > 0; }

      function syncUIForMode(){
        const isSearching = searching();
        yearSel.disabled = isSearching;
        statusSel.disabled = isSearching;
        lawyerSel.disabled = isSearching;
        typeSel.disabled = isSearching;

        if (isSearching){
          searchHL.textContent = state.query;
          searchTag.style.display = "inline-flex";
          q.title = "Search by MatterID, Client, or Subject. Filters are ignored while searching. Press Esc to clear.";
        } else {
          searchTag.style.display = "none";
          q.placeholder = "Search by MatterID, Client, or Subject";
          q.title = "Search by MatterID, Client, or Subject. Press Enter to search. Filters are ignored while searching. Press Esc to clear.";
        }
      }

      function computeIds(){
        const qtext = norm(state.query).trim().toLowerCase();

        if (qtext){
          const ids = [];
          for (let i=0; i<rows.length; i++){
            if (rows[i]._search.indexOf(qtext) !== -1) ids.push(rows[i].id);
          }
          return ids;
        }

        const y = norm(state.year);
        const s = norm(state.status);
        const l = norm(state.lawyer);
        const t = norm(state.type);

        const ids = [];
        for (let i=0; i<rows.length; i++){
          const r = rows[i];
          if (y && norm(r.MTR_YEAR) !== y) continue;
          if (s && norm(r.Status) !== s) continue;
          if (l && norm(r.Lawyer) !== l) continue;
          if (t && norm(r.Mtr_Type) !== t) continue;
          ids.push(r.id);
        }
        return ids;
      }

      function applySelection(){
        const ids = computeIds();
        countEl.textContent = `${ids.length} matches`;
        grist.setSelectedRows(ids.length ? ids : null);
      }

      function renderOptions(){
        const years = sortYears(uniq(rows.map(r => r.MTR_YEAR)));
        const statuses = sortAlpha(uniq(rows.map(r => r.Status)));
        const lawyers = sortAlpha(uniq(rows.map(r => r.Lawyer)));
        const types = sortAlpha(uniq(rows.map(r => r.Mtr_Type)));

        fillSelect(yearSel, years, state.year, "All years");
        fillSelect(statusSel, statuses, state.status, "All statuses");
        fillSelect(lawyerSel, lawyers, state.lawyer, "All lawyers");
        fillSelect(typeSel, types, state.type, "All types");
      }

      function updateClearX(){
        clearX.style.display = norm(state.queryDraft).length > 0 ? "inline-flex" : "none";
      }

      function clearSearch(){
        state.queryDraft = "";
        state.query = "";
        q.value = "";
        updateClearX();
        syncUIForMode();
        applySelection();
      }

      q.addEventListener("input", () => {
        state.queryDraft = q.value;
        updateClearX();
      });

      q.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter"){
          ev.preventDefault();
          state.query = norm(state.queryDraft).trim();
          syncUIForMode();
          applySelection();
        } else if (ev.key === "Escape"){
          ev.preventDefault();
          clearSearch();
        }
      });

      clearX.addEventListener("click", () => { clearSearch(); q.focus(); });

      yearSel.addEventListener("change", () => { state.year = yearSel.value; applySelection(); });
      statusSel.addEventListener("change", () => { state.status = statusSel.value; applySelection(); });
      lawyerSel.addEventListener("change", () => { state.lawyer = lawyerSel.value; applySelection(); });
      typeSel.addEventListener("change", () => { state.type = typeSel.value; applySelection(); });

      clearBtn.addEventListener("click", () => {
        state.queryDraft = "";
        state.query = "";
        q.value = "";
        updateClearX();

        state.year = "";
        state.status = "";
        state.lawyer = "";
        state.type = "";

        applyDefaultsIfEmpty();
        renderOptions();
        syncUIForMode();
        applySelection();
      });

      setErr("");
      grist.fetchSelectedTable({ format:"rows" })
        .then(data => {
          const all = data || [];
          if (!all.length){
            setErr("No rows returned. Check Select Data = Matters and access level.");
            return;
          }

          const first = all[0] || {};
          const required = ["MatterID","Clients","Subject","Subject2","Lawyer","Mtr_Type","MTR_YEAR","Status"];
          const missing = required.filter(k => !(k in first));
          if (missing.length){
            setErr("Missing column(s): " + missing.join(", "));
            return;
          }

          rows = all.map(r => {
            const searchBlob = (
              norm(r.MatterID) + " " +
              norm(r.Clients) + " " +
              norm(r.Subject) + " " +
              norm(r.Subject2)
            ).toLowerCase();

            return {
              id: r.id,
              MTR_YEAR: r.MTR_YEAR,
              Status: r.Status,
              Lawyer: r.Lawyer,
              Mtr_Type: r.Mtr_Type,
              _search: searchBlob
            };
          });

          applyDefaultsIfEmpty();
          renderOptions();
          syncUIForMode();
          applySelection();
        })
        .catch(e => setErr("fetchSelectedTable failed: " + (e && e.message ? e.message : e)));
    }
  </script>
</body>
</html>
