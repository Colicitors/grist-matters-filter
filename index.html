<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matters Filter</title>

  <!-- Grist Plugin API -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <style>
    :root{
      /* Light Teal Theme */
      --page: #eaf7f6;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #47636b;
      --teal: #0ea5a4;
      --teal2:#14b8a6;
      --ring: rgba(20,184,166,.35);
      --border: rgba(2,132,126,.18);
      --shadow: 0 10px 25px rgba(2,132,126,.12);

      /* Compact sizing: target ~1.5in tall */
      --pad: 8px;
      --gap: 8px;
      --radius: 12px;
      --controlH: 30px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    html, body { height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      background: linear-gradient(180deg, #f2fbfa, var(--page));
      color: var(--ink);
    }

    /* Keep everything tight */
    .shell{ padding: var(--pad); }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--gap);
      padding: 8px 10px;
      background: linear-gradient(90deg, rgba(20,184,166,.14), rgba(14,165,164,.07));
      border-bottom: 1px solid var(--border);
    }

    .title{
      font-weight: 700;
      font-size: 12.5px;
      letter-spacing: .2px;
      color: #0b3d3f;
    }

    .right{
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }

    .pill{
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(20,184,166,.12);
      border: 1px solid rgba(20,184,166,.25);
      color: #0b3d3f;
    }

    button{
      height: var(--controlH);
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(14,165,164,.30);
      background: rgba(14,165,164,.10);
      color: #0b3d3f;
      font-size: 12px;
      cursor:pointer;
    }
    button:hover{ background: rgba(14,165,164,.14); }
    button:focus{ outline: none; box-shadow: 0 0 0 3px var(--ring); }

    .content{
      padding: 8px 10px 10px;
      display:grid;
      gap: var(--gap);
    }

    /* Two compact rows */
    .row{
      display:grid;
      gap: var(--gap);
    }

    /* Row 1: Search + Year + Status */
    .row1{
      grid-template-columns: 1.6fr 0.7fr 0.7fr;
      align-items:end;
    }

    /* Row 2: Lawyer + Matter Type + (hint) */
    .row2{
      grid-template-columns: 1fr 1fr auto;
      align-items:end;
    }

    .field{
      display:grid;
      gap: 4px;
      min-width: 0;
    }

    label{
      font-size: 11px;
      color: var(--muted);
      line-height: 1;
    }

    input, select{
      height: var(--controlH);
      border-radius: 10px;
      border: 1px solid rgba(15,118,110,.22);
      background: #fbfefe;
      padding: 0 10px;
      font-size: 12px;
      color: var(--ink);
      outline: none;
      min-width: 0;
    }

    input:focus, select:focus{
      box-shadow: 0 0 0 3px var(--ring);
      border-color: rgba(14,165,164,.55);
    }

    .hint{
      font-size: 11px;
      color: var(--muted);
      padding-bottom: 2px;
      justify-self: end;
      text-align:right;
      max-width: 220px;
      line-height: 1.1;
    }

    .err{
      font-size: 11px;
      color: #b91c1c;
      margin-top: -4px;
    }

    /* Make it resilient on smaller widths: wrap to 2 columns */
    @media (max-width: 520px){
      .row1{ grid-template-columns: 1fr 1fr; }
      .row2{ grid-template-columns: 1fr 1fr; }
      .hint{ justify-self: start; text-align:left; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="card">
      <div class="topbar">
        <div class="title">Matters</div>
        <div class="right">
          <span class="pill" id="count">0 matches</span>
          <button id="clearBtn" title="Reset filters">Clear</button>
        </div>
      </div>

      <div class="content">
        <div class="row row1">
          <div class="field">
            <label for="q">Search (MatterID, Clients, Subject, Subject2)</label>
            <input id="q" type="search" placeholder="Type to search…" autocomplete="off" />
          </div>

          <div class="field">
            <label for="yearSel">Select Matter Year</label>
            <select id="yearSel"></select>
          </div>

          <div class="field">
            <label for="statusSel">Select Matter Status</label>
            <select id="statusSel"></select>
          </div>
        </div>

        <div class="row row2">
          <div class="field">
            <label for="lawyerSel">Lawyer</label>
            <select id="lawyerSel"></select>
          </div>

          <div class="field">
            <label for="typeSel">Matter Type</label>
            <select id="typeSel"></select>
          </div>

          <div class="hint" id="hint">Loading…</div>
        </div>

        <div class="err" id="err"></div>
      </div>
    </div>
  </div>

  <script>
    // Request read access; enable "Select By" linking
    grist.ready({ requiredAccess: "read table", allowSelectBy: true });

    const q = document.getElementById("q");
    const yearSel = document.getElementById("yearSel");
    const statusSel = document.getElementById("statusSel");
    const lawyerSel = document.getElementById("lawyerSel");
    const typeSel = document.getElementById("typeSel");
    const countEl = document.getElementById("count");
    const hintEl = document.getElementById("hint");
    const errEl = document.getElementById("err");
    const clearBtn = document.getElementById("clearBtn");

    // Data: keep only what we need (fast & memory-friendly)
    // Expected columns (from your Matters table):
    // MatterID, Clients, Subject, Subject2, Lawyer, Mtr_Type, MTR_YEAR, Status
    let rows = [];  // {id, MTR_YEAR, Status, Lawyer, Mtr_Type, _search}
    let state = {
      query: "",
      year: "",
      status: "",
      lawyer: "",
      type: ""
    };

    function norm(v){ return (v === null || v === undefined) ? "" : String(v); }
    function setErr(msg){ errEl.textContent = msg || ""; }

    function fillSelect(sel, items, selected, allLabel){
      sel.innerHTML = "";
      const all = document.createElement("option");
      all.value = "";
      all.textContent = allLabel;
      sel.appendChild(all);

      items.forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v === "" ? "(blank)" : v;
        sel.appendChild(o);
      });

      sel.value = selected || "";
    }

    function uniq(arr){
      const s = new Set(arr.map(norm));
      return [...s].filter(v => v !== "");
    }

    function sortYears(years){
      return years
        .map(v => Number(v))
        .filter(n => !Number.isNaN(n))
        .sort((a,b) => b-a)           // newest first
        .map(String);
    }

    function sortAlpha(items){
      return items.sort((a,b) => a.localeCompare(b, undefined, { sensitivity: "base" }));
    }

    function chooseDefaultsIfEmpty(){
      // default year = current year if present
      if (!state.year){
        const currentYear = String(new Date().getFullYear());
        const years = new Set(rows.map(r => norm(r.MTR_YEAR)));
        if (years.has(currentYear)) state.year = currentYear;
      }

      // default status = Active if present
      if (!state.status){
        const statuses = new Set(rows.map(r => norm(r.Status)));
        if (statuses.has("Active")) state.status = "Active";
      }
    }

    function computeIds(){
      const qtext = norm(state.query).trim().toLowerCase();
      const y = norm(state.year);
      const s = norm(state.status);
      const l = norm(state.lawyer);
      const t = norm(state.type);

      const ids = [];
      for (let i=0; i<rows.length; i++){
        const r = rows[i];

        // AND filters
        if (y && norm(r.MTR_YEAR) !== y) continue;
        if (s && norm(r.Status) !== s) continue;
        if (l && norm(r.Lawyer) !== l) continue;
        if (t && norm(r.Mtr_Type) !== t) continue;

        // Search
        if (qtext && r._search.indexOf(qtext) === -1) continue;

        ids.push(r.id);
      }
      return ids;
    }

    function applySelection(){
      const ids = computeIds();
      countEl.textContent = `${ids.length} matches`;
      grist.setSelectedRows(ids.length ? ids : null);
    }

    function renderOptions(){
      const years = sortYears(uniq(rows.map(r => r.MTR_YEAR)));
      const statuses = sortAlpha(uniq(rows.map(r => r.Status)));
      const lawyers = sortAlpha(uniq(rows.map(r => r.Lawyer)));
      const types = sortAlpha(uniq(rows.map(r => r.Mtr_Type)));

      fillSelect(yearSel, years, state.year, "All years");
      fillSelect(statusSel, statuses, state.status, "All statuses");
      fillSelect(lawyerSel, lawyers, state.lawyer, "All lawyers");
      fillSelect(typeSel, types, state.type, "All types");

      applySelection();
    }

    // Debounce typing so search is smooth
    let debounce = null;
    function scheduleApply(){
      if (debounce) clearTimeout(debounce);
      debounce = setTimeout(applySelection, 120);
    }

    // Events
    q.addEventListener("input", () => {
      state.query = q.value;
      scheduleApply();
    });

    yearSel.addEventListener("change", () => {
      state.year = yearSel.value;
      // optionally tighten Status list by year (if you want dependent dropdowns later)
      applySelection();
    });

    statusSel.addEventListener("change", () => {
      state.status = statusSel.value;
      applySelection();
    });

    lawyerSel.addEventListener("change", () => {
      state.lawyer = lawyerSel.value;
      applySelection();
    });

    typeSel.addEventListener("change", () => {
      state.type = typeSel.value;
      applySelection();
    });

    clearBtn.addEventListener("click", () => {
      state.query = "";
      state.year = "";
      state.status = "";
      state.lawyer = "";
      state.type = "";
      q.value = "";
      chooseDefaultsIfEmpty();   // reapply defaults after clearing
      renderOptions();
    });

    // Load data once
    hintEl.textContent = "Loading Matters…";
    grist.fetchSelectedTable({ format: "rows" })
      .then(data => {
        setErr("");
        const all = data || [];
        if (!all.length){
          hintEl.textContent = "No rows.";
          setErr("No rows returned. Check Select Data = Matters and access level.");
          return;
        }

        // Validate required columns exist (fail with helpful message if not)
        const first = all[0] || {};
        const required = ["MatterID","Clients","Subject","Subject2","Lawyer","Mtr_Type","MTR_YEAR","Status"];
        const missing = required.filter(k => !(k in first));
        if (missing.length){
          hintEl.textContent = "Schema mismatch";
          setErr("Missing column(s): " + missing.join(", "));
          return;
        }

        // Reduce and precompute search text for speed
        rows = all.map(r => {
          const searchBlob = (
            norm(r.MatterID) + " " +
            norm(r.Clients) + " " +
            norm(r.Subject) + " " +
            norm(r.Subject2)
          ).toLowerCase();

          return {
            id: r.id,
            MTR_YEAR: r.MTR_YEAR,
            Status: r.Status,
            Lawyer: r.Lawyer,
            Mtr_Type: r.Mtr_Type,
            _search: searchBlob
          };
        });

        hintEl.textContent = `Loaded ${rows.length} rows`;
        chooseDefaultsIfEmpty();
        renderOptions();
      })
      .catch(e => {
        hintEl.textContent = "Load failed";
        setErr("fetchSelectedTable failed: " + (e && e.message ? e.message : e));
      });
  </script>
</body>
</html>
